---
apiVersion: v1
kind: Pod
metadata:
  name: "proxy-ci-test-pod"
spec:
  restartPolicy: Never
  terminationGracePeriodSeconds: 10
  hostAliases:
  - ip: "127.0.0.1"
    hostnames:
    - "bucketwebsitetester.s3-website-us-east-1.amazonaws.com"
    - "testrequestbucket.localhost"
    - "pykmip.local"
  {% if vars.pykmip is defined and vars.pykmip == 'enabled' -%}
  initContainers:
    - name: kmip-certs-installer
      image: {{ images.pykmip }}
      command: [ 'sh', '-c', 'cp /ssl/* /ssl-kmip/']
      volumeMounts:
        - name: kmip-certs
          readOnly: false
          mountPath: /ssl-kmip
  {%- endif %}
  containers:
    {% if vars.env.S3METADATA is defined and vars.env.S3METADATA == "mongodb" -%}
    - name: mongo
      image: scality/ci-mongo:3.6.8
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 500m
          memory: 1Gi
    {%- endif %}
    - name: aggressor
      image: {{ images.aggressor }}
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: "1"
          memory: {{ vars.aggressorMem }}
        limits:
          cpu: "1"
          memory: {{ vars.aggressorMem }}
      volumeMounts:
        - name: creds
          readOnly: false
          mountPath: /root/.aws
        - name: artifacts
          readOnly: true
          mountPath: /artifacts
      command:
        - bash
        - -lc
        - |
          buildbot-worker create-worker . $BUILDMASTER:$BUILDMASTER_PORT $WORKERNAME $WORKERPASS
          buildbot-worker start --nodaemon
      env:
        - name: CI
          value: "true"
        - name: ENABLE_LOCAL_CACHE
          value: "true"
        - name: REPORT_TOKEN
          value: "report-token-1"
        - name: REMOTE_MANAGEMENT_DISABLE
          value: "1"
        {% for key, value in vars.env.items() %}
        - name: {{ key }}
          value: "{{ value }}"
        {% endfor %}
    - name: s3
      image: {{ images.s3 }}
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: "1750m"
          memory: {{ vars.s3Mem }}
        limits:
          cpu: "1750m"
          memory: {{ vars.s3Mem }}
      volumeMounts:
        - name: creds
          readOnly: false
          mountPath: /root/.aws
        - name: certs
          readOnly: false
          mountPath: /tmp
        - name: artifacts
          readOnly: false
          mountPath: /artifacts
        - name: kmip-certs
          readOnly: false
          mountPath: /ssl-kmip
      command:
        - bash
        - -ec
        - |
          sleep 10 # wait for mongo
          /usr/src/app/docker-entrypoint.sh yarn start | tee -a /artifacts/s3.log
      env:
        {% if vars.env.S3DATA is defined and vars.env.S3DATA == "multiple" and vars.env.CI_CEPH is not defined -%}
        - name: S3_LOCATION_FILE
          value: "/usr/src/app/tests/locationConfig/locationConfigTests.json"
        {%- endif %}
        {% if vars.env.S3DATA is defined and vars.env.S3DATA == "multiple" and vars.env.CI_CEPH is defined and vars.env.CI_CEPH == "true" -%}
        - name: S3_LOCATION_FILE
          value: "/usr/src/app/tests/locationConfig/locationConfigCeph.json"
        {%- endif %}
        {% if vars.pykmip is defined and vars.pykmip == 'enabled' -%}
        - name: S3KMS
          value: kmip
        - name: S3KMIP_PORT
          value: "5696"
        - name: S3KMIP_HOSTS
          value: "pykmip.local"
        - name: S3KMIP_COMPOUND_CREATE
          value: "false"
        - name: S3KMIP_BUCKET_ATTRIBUTE_NAME
          value: ''
        - name: S3KMIP_PIPELINE_DEPTH
          value: "8"
        - name: S3KMIP_KEY
          value: /ssl-kmip/kmip-client-key.pem
        - name: S3KMIP_CERT
          value: /ssl-kmip/kmip-client-cert.pem
        - name: S3KMIP_CA
          value: /ssl-kmip/kmip-ca.pem
        {%- endif %}
        - name: CI
          value: "true"
        - name: ENABLE_LOCAL_CACHE
          value: "true"
        - name: MONGODB_HOSTS
          value: "localhost:27018"
        - name: MONGODB_RS
          value: "rs0"
        - name: REDIS_HOST
          value: "localhost"
        - name: REDIS_PORT
          value: "6379"
        - name: REPORT_TOKEN
          value: "report-token-1"
        - name: REMOTE_MANAGEMENT_DISABLE
          value: "1"
        - name: HEALTHCHECKS_ALLOWFROM
          value: "0.0.0.0/0"
        {% for key, value in vars.env.items() %}
        - name: {{ key }}
          value: "{{ value }}"
        {% endfor %}
    {% if vars.redis is defined and vars.redis == "enabled" -%}
    - name: redis
      image: redis:alpine
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: 200m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 128Mi
    {%- endif %}
    {% if vars.env.CI_PROXY is defined and vars.env.CI_PROXY == "true" -%}
    - name: squid
      image: scality/ci-squid
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: 250m
          memory: 128Mi
        limits:
          cpu: 250m
          memory: 128Mi
      volumeMounts:
        - name: certs
          readOnly: false
          mountPath: /ssl
      command:
        - sh
        - -exc
        - |
          mkdir -p /ssl
          openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 \
           -subj "/C=US/ST=Country/L=City/O=Organization/CN=CN=scality-proxy" \
           -keyout /ssl/myca.pem  -out /ssl/myca.pem
          cp /ssl/myca.pem /ssl/CA.pem
          squid -f /etc/squid/squid.conf -N -z
          squid -f /etc/squid/squid.conf -NYCd 1
    {%- endif %}
    {% if vars.env.CI_CEPH is defined and vars.env.CI_CEPH == "true" -%}
    - name: ceph
      image: {{ images.ceph }}
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: 500m
          memory: 1536Mi
        limits:
          cpu: 500m
          memory: 1536Mi
      volumeMounts:
        - name: artifacts
          readOnly: false
          mountPath: /artifacts
    {%- endif %}
    {% if vars.pykmip is defined and vars.pykmip == 'enabled' -%}
    - name: pykmip
      image: {{ images.pykmip }}
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - name: artifacts
          readOnly: false
          mountPath: /artifacts
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 100m
          memory: 128Mi
    {%- endif %}
    {% if vars.env.S3DATA is defined and vars.env.S3DATA == "multiple" -%}
    - name: azurite
      image: mcr.microsoft.com/azure-storage/azurite:3.13.0
      command: ['azurite']
      args: ['--blobHost', '0.0.0.0', '--debug', '/artifacts/azurite.log']
      env:
      - name: AZURITE_ACCOUNTS
        value: "fakeaccountname:Fake00Key001;fakeaccountname2:Fake00Key002"
      volumeMounts:
        - name: azurite
          mountPath: /data
        - name: artifacts
          mountPath: /artifacts
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 100m
          memory: 256Mi
    {% endif %}
  volumes:
    - name: creds
      emptyDir: {}
    - name: certs
      emptyDir: {}
    - name: artifacts
      emptyDir: {}
    - name: kmip-certs
      emptyDir: {}
    - name: azurite
      emptyDir: {}
